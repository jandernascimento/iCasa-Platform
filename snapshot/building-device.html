<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at May 17, 2013
 | Rendered using Apache Maven Fluido Skin 1.2.2
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iCasa Platform</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido.min.js"></script>

          
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="stylesheet" type="text/css" href="./css/site.css"/>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="stylesheet" type="text/css" href="./css/font-awesome.css"/>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<script type="text/javascript">var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-35847694-2']);
                _gaq.push(['_trackPageview']);

                (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();</script>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<script type="text/javascript">$(document).ready(function () {
                $("pre code").parent().addClass("prettyprint");
                prettyPrint();
                });</script>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="shortcut icon" href="favicon.png"/>
          
    <meta name="Date-Revision-yyyymmdd" content="20130517" />
    <meta http-equiv="Content-Language" content="en" />
            </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="http://github.com/AdeleResearchGroup/iCasa-Platform">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 100;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="#" id="bannerLeft">
                                                                                                <img src="icasa-small.png"  alt="iCasa Platform - Execution Platform for Digital Home applications"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
            
                  <li id="publishDate">Last Published: 2013-05-17</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 1.0.1-SNAPSHOT</li>
                      
                
            
      
                            </ul>
      </div>

            <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
            
                                    <h3>iCasa Platform</h3>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="license.html" title="License">License</a>
            </li>
                  <li class="none">
                          <a href="overview.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="install.html" title="Install">Install</a>
            </li>
          </ul>
                        <h3>User Guide</h3>
                  <ul>
                  <li class="none">
                          <a href="rest-api.html" title="REST API">REST API</a>
            </li>
                  <li class="none">
                          <a href="gogo-commands.html" title="Gogo commands">Gogo commands</a>
            </li>
                  <li class="none">
            <strong>Device Building Tutorial</strong>
          </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="Javadoc">Javadoc</a>
            </li>
          </ul>
                        <h3>Project Documentation</h3>
                  <ul>
                                                                                                                                                                                                                                                                                                                                <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                                                            <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                      
            
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="http://adeleresearchgroup.github.com/iCasa-Platform" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>How to build an iCasa Device</h1>

<ul>
<li><a href="#Requirements">Tutorial Requirements</a></li>
<li><a href="#Model">iCasa Device Model</a></li>
<li><a href="#Simulated">Simulated Devices</a></li>
<li><a href="#Device_Scope">Device Using Scope Zone</a>
<ul><li><a href="#Description">Device Description</a>: shows how to describe the device in the iCasa platform</li>
<li><a href="#Implementation">Device Implementation</a>: presents the java class implementing the simulated device functionality
<ul><li><a href="#Properties">Properties initialization</a></li>
<li><a href="#Scope">Scope Utilization</a></li>
<li><a href="#Listener">Zone Listener</a></li></ul></li></ul></li>
<li><a href="#Component">Device Component</a></li>
<li><a href="#Packaging">Device Bundle Packaging</a>
<ul><li><a href="#POM">POM Example</a>: thermoter device POM file</li></ul></li>
</ul>

<p><a name="Requirements"></a></p>

<h2>Tutorial Requirements</h2>

<ul>
<li>OSGi &amp; iPOJO : iCasa is built on top of <a href="http://www.osgi.org">OSGi</a> platform and <a href="http://felix.apache.org/site/apache-felix-ipojo.html">iPOJO</a> component model</li>
<li>Maven (Optional) : <a href="http://maven.apache.org/">Maven</a> tool can be used to build new iCasa devices</li>
</ul>

<p><a name="Model"></a></p>

<h2>iCasa Device Model</h2>

<p>iCasa framework provides a device model that must be used to create new devices. In this model, each device has to publish a description based in a Java interface and a set of properties. Device interface is used to expose device functionality, on the other hand properties set is used to known device state.</p>

<p>To integrate a new device into the iCasa framework the device has to implement the <strong><em>fr.liglab.adele.icasa.device.GenericDevice</em></strong> interface. The GenericDevice interface defines methods to get the device unique identifier (<strong><em>getSerialNumber()</em></strong>), to access its state (<strong><em>getState()</em></strong>) and its fault situation (<strong><em>getFault()</em></strong>), and also a method to interrogate device to obtain its properties values (<strong><em>getPropertyValue(String propertyName)</em></strong>).</p>

<p>In addition, each device has the possibility of notify clients about changes in its state (when its properties' values have been changed) using the listener pattern. The device sends events to its listeners using a callback method (<strong><em>devicePropertyModified(GenericDevice device, String propertyName, Object oldValue)</em></strong>). Events sent must implement the Java interface <strong><em>fr.liglab.adele.icasa.device.DeviceEvent</em></strong> and listeners must implement <strong><em>fr.liglab.adele.icasa.device.DeviceListener</em></strong> interface.</p>

<p>iCasa framework provides an abstract implementation class for <em>GenericDevice</em> interface: <strong><em>fr.liglab.adele.icasa.device.util.AbstractDevice</em></strong>. This abstract class eases the development of new devices implementation by inheriting from it. There exists mainly two types of devices in iCasa: devices using a scope zone and localization (thermometer gets the temperature of a room by example) and devices that are independent of their localization i.e. a bathroom scale.</p>

<p><a name="Simulated"></a></p>

<h2>Simulated Devices</h2>

<p>Testing and debugging pervasive applications is a difficult task because usually developers have not access to all physical devices. On the other hand is not easy to generate the adequate events in the right moment in order to produce conditions for testing applications in different execution scenarios. For this reason iCasa framework includes a simulation module allowing testing and debugging of pervasive applications. 
The iCasa simulation module provides a set of prebuilt simulated devices, it is extensible, allowing developers to build new types of simulated devices. Every simulated device is a full compliant iCasa device, but simulated device must implement <em>fr.liglab.adele.icasa.simulator.SimulatedDevice</em> interface to be recognized by the iCasa simulation framework. </p>

<p><a name="Device_Scope"></a></p>

<h2>Device using scope zone: A Thermometer Device</h2>

<p>In this section we will show how to extend the iCasa simulation module adding a new simulated device that uses a scope zone; the thermometer device. The section is divided in 4 subsections:</p>

<p><a name="Description"></a></p>

<h3>Device Description</h3>

<p>As show in the next code fragment, the description of the Thermometer device includes is made in a Java interface (<strong><em>fr.liglab.adele.icasa.device.temperature.Thermometer</em></strong>) and a set of properties (<em>state</em>, <em>fault</em> and <em>current</em>temperature<em>). Usually the properties name are defined as static fields (constants) of the Java interface as <em>THERMOMETER</em>CURRENT_TEMPERATURE</em> .</p>

<p>The Thermometer java interface is as follows</p>

<pre><code>package fr.liglab.adele.icasa.device.temperature;

import fr.liglab.adele.icasa.device.GenericDevice;

public interface Thermometer extends GenericDevice {

   static String THERMOMETER_CURRENT_TEMPERATURE = "current_temperature"; // Temperature Property

   double getTemperature();

}
</code></pre>

<p>To access device current temperature the client has two options, call the method <strong>getTemperature()</strong> or ask for the <strong>current_temperature</strong> property.</p>

<p><a name="Implementation"></a></p>

<h3>Device Implementation</h3>

<p>Once the device interface defined a implementation class to this device must be provided. </p>

<pre><code>package fr.liglab.adele.icasa.device.temperature.impl;

// Imports section omitted

@Component(name = "iCASA.Thermometer")
@Provides(properties = { @StaticServiceProperty(type = "java.lang.String", name = Constants.SERVICE_DESCRIPTION) })
public class SimulatedThermometerImpl extends AbstractDevice implements Thermometer, SimulatedDevice {

    @ServiceProperty(name = Thermometer.DEVICE_SERIAL_NUMBER, mandatory = true)
    private String m_serialNumber;

    private volatile Zone m_zone;

    private ZoneListener listener = new ThermometerZoneListener();

    public SimulatedThermometerImpl() {
        super();

        // Property initialization
        setPropertyValue(Thermometer.THERMOMETER_CURRENT_TEMPERATURE, 0.0); 
    }

    @Override
    public String getSerialNumber() {
        return m_serialNumber;
    }

    @Override
    public synchronized double getTemperature() {
        return (Double) getPropertyValue(Thermometer.THERMOMETER_CURRENT_TEMPERATURE);
    }

    @Override
    public void enterInZones(List&lt;Zone&gt; zones) {
        if (!zones.isEmpty()) {
            for (Zone zone : zones) {
                if (zone.getVariableValue("Temperature") != null) {
                    m_zone = zone;
                    getTemperatureFromZone();

                    // Zone listener registration
                    m_zone.addListener(listener);
                    break;
                }
            }
        }
    }

    @Override
    public void leavingZones(List&lt;Zone&gt; zones) {
        setPropertyValue(Thermometer.THERMOMETER_CURRENT_TEMPERATURE, null);
        // Zone listener unregistration
        if (m_zone != null)         
            m_zone.removeListener(listener);
    }

    private void getTemperatureFromZone() {
        if (m_zone != null) {
            Object currentTemperature = m_zone.getVariableValue("Temperature");
            if (currentTemperature != null)
                setPropertyValue(Thermometer.THERMOMETER_CURRENT_TEMPERATURE, currentTemperature);
        }
    }

    // Zone listener implementation
    class ThermometerZoneListener extends BaseZoneListener {

        @Override
        public void zoneVariableModified(Zone zone, String variableName, Object oldValue) {

            if (m_zone == zone) {
                if (!(getFault().equalsIgnoreCase("yes")))
                    if (variableName.equals("Temperature"))
                        getTemperatureFromZone();
            }
        }
    }

}
</code></pre>

<p><a name="Properties"></a>   </p>

<h4>Device Properties Initialization</h4>

<p>The device's properties should be initialized for two reasons: 
- to establish the initial state of the device
- to avoid any problem of associated to null pointers in the device implementation</p>

<p>Usually, this initialization should be done in the constructor as show in the class SimulatedThermometerImpl above.</p>

<p><a name="Scope"></a></p>

<h4>Zones Scope Utilisation</h4>

<p>As is shown in the SimulatedThermometerImpl class two methods have been implemented: enterInZones and leaveZones, these methods are callback methods defined in GenericDevice interface. iCasa platform call these methods when de device is placed in a new Zone to indicate its new scope zones and which are it leaving. In our example the device will try to find the first Zone that contains the <em>Temperature</em> variable. Then, the simulated device uses the Temperature variable to obtain the value used in to set its property current_temperature</p>

<p><a name="Listener"></a></p>

<h4>Zone Listener</h4>

<p>The SimulatedThermometerImpl class defines an inner class <em>ThermometerZoneListener</em> to be notified when variables in its scope zone have been modified. Our listener is interested in changes in Temperature variable in the device's scope zone. 
This listener has to be subscribed to zone events as is done in enterInZones method ( <em>m</em>zone.addListener(listener)_ ), and in leavingZones method the listener is unregistered.</p>

<p><a name="Component"></a></p>

<h2>Device Component</h2>

<p>The iCasa platform has been built on top of the OSGi and iPOJO technologies. Each device to be incorporated to iCasa framework has to be built as an iPOJO component and deployed in the runtime as an OSGi Bundle.
Some iPOJO annotations are defined in the previous implementation class, these annotations (<em>@Component</em>, <em>@Provides</em>) indicates the iPOJO manipulator tool and iPOJO runtime how to deal with the component. In our example we are indicating that the component is called "iCASA.Thermometer" and that it is providing all implemented interfaces (GenericDevice, SimulatedDevice and Thermometer) as OSGi services.
To know more about the iPOJO compoenent model see <a href="http://felix.apache.org/site/apache-felix-ipojo.html">this</a> and for OSGI <a href="http://www.osgi.org">this</a>.</p>

<p><a name="Packaging"></a></p>

<h2>Device Packaging</h2>

<p>You can use <a href="http://felix.apache.org/site/apache-felix-ipojo.html">maven</a> tool to build a device project. Two iCasa maven artifacts are necessary to build your project, the first one context.api defines the interfaces used in the Device model, the simulation.api provides the SimulatedDevice interface.</p>

<p>Artifacs :</p>

<p><strong><em>Context API - Device interfaces</em></strong></p>

<pre><code>&lt;groupId&gt;fr.liglab.adele.icasa&lt;/groupId&gt;
&lt;artifactId&gt;context.api&lt;/artifactId&gt;
&lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
</code></pre>

<p><strong><em>Simulation API - Simulated Device interface</em></strong></p>

<pre><code>&lt;groupId&gt;fr.liglab.adele.icasa&lt;/groupId&gt;
&lt;artifactId&gt;simulator.api&lt;/artifactId&gt;
&lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
</code></pre>

<p><a name="POM"></a>  </p>

<h3>Thermometer Pom Model File</h3>

<p>The pom file used in iCasa simulator module to build the simulated Thermometer is shown in the next fragment code. In addition to the two iCasa artifacts this pom includes other dependencies to iPojo and OSGi code. Finally, the pom defines the utilization of two plugins to iPOJO manipulation and OSGi bundle packaging.</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;
   &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

   &lt;!-- Project coordinates --&gt;
   &lt;artifactId&gt;device.temperature&lt;/artifactId&gt;
   &lt;packaging&gt;bundle&lt;/packaging&gt;
   &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;


   &lt;!-- Project dependencies --&gt;
   &lt;dependencies&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.osgi&lt;/groupId&gt;
         &lt;artifactId&gt;org.osgi.core&lt;/artifactId&gt;
         &lt;version&gt;4.2.0&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
         &lt;artifactId&gt;org.apache.felix.ipojo&lt;/artifactId&gt;
         &lt;version&gt;1.8.2&lt;/version&gt;
      &lt;/dependency&gt;  
      &lt;dependency&gt;
         &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
         &lt;artifactId&gt;org.apache.felix.ipojo.annotations&lt;/artifactId&gt;
         &lt;version&gt;1.8.2&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;fr.liglab.adele.icasa&lt;/groupId&gt;
         &lt;artifactId&gt;context.api&lt;/artifactId&gt;
         &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;fr.liglab.adele.icasa&lt;/groupId&gt;
        &lt;artifactId&gt;simulator.api&lt;/artifactId&gt;
        &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
      &lt;/dependency&gt;
   &lt;/dependencies&gt;

   &lt;build&gt;
     &lt;plugins&gt;
       &lt;plugin&gt;
          &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
          &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
          &lt;version&gt;2.3.7&lt;/version&gt;
          &lt;configuration&gt;
            &lt;instructions&gt;
               &lt;Private-Package&gt;fr.liglab.adele.icasa.device.temperature.impl&lt;/Private-Package&gt;
            &lt;/instructions&gt;
          &lt;/configuration&gt;
        &lt;/plugin&gt;
     &lt;plugin&gt;
       &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
       &lt;artifactId&gt;maven-ipojo-plugin&lt;/artifactId&gt;
       &lt;version&gt;1.8.6&lt;/version&gt;
     &lt;/plugin&gt;
   &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>

<p></project></p>

                  </div>
            </div>
      
    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2012-2013
                        <a href="http://www-adele.imag.fr/">Adele Team</a>.
            All Rights Reserved.      
            
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
